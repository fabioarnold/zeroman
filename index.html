<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Zero Man</title>
  <style type="text/css">
    * {
      touch-action: none;
      user-select: none;
      -webkit-user-select: none;
    }
    body {
      margin: 0;
      overflow: hidden;
    }
    canvas {
      display: block;
      cursor: none;
    }
    .touchcontrol path, .touchcontrol circle {
      fill: #fff0;
    }
    .touchcontrol-enabled path, .touchcontrol-enabled circle {
      fill: #fff4;
    }
  </style>
</head>

<body>
  <canvas id="canvasgl"></canvas>
  <svg class="touchcontrol" style="position:absolute;height:min(45vw,45vh);bottom:5%;left:5%;" viewBox="0 0 30 30">
    <path d="M0 10 V20 H9 L14 15 9 10 Z" onpointerenter="pressedKeys[37]=true" onpointerleave="pressedKeys[37]=false" />
    <path d="M20 0 H10 V9 L15 14 20 9 Z" onpointerenter="pressedKeys[38]=true" onpointerleave="pressedKeys[38]=false" />
    <path d="M30 20 V10 H21 L16 15 21 20 Z" onpointerenter="pressedKeys[39]=true" onpointerleave="pressedKeys[39]=false" />
    <path d="M10 30 H20 V21 L15 16 10 21 Z" onpointerenter="pressedKeys[40]=true" onpointerleave="pressedKeys[40]=false" />
  </svg>
  <svg class="touchcontrol" style="position:absolute;height:min(45vw,45vh);bottom:5%;right:5%;" viewBox="0 0 30 30">
    <circle cx="15" cy="15" r="10" onpointerenter="pressedKeys[32]=true" onpointerleave="pressedKeys[32]=false"/>
  </svg>
  <script>
    var $canvasgl = document.getElementById("canvasgl");
  </script>
  <!-- <script src="js/dom.js"></script> -->
  <!-- <script src="js/audio.js"></script> -->
  <!-- <script src="js/canvas.js"></script> -->
  <script src="js/webgl.js"></script>
  <!-- <script src="js/wasm.js"></script> -->
  <script>
    const env = {
      // ...wasm,
      // ...audio,
      // ...canvas,
      // ...zigdom,
      ...webgl,
      jsConsoleLog,
      isKeyDown,
      isButtonDown,
    }

    let pressedKeys = {};
    function isKeyDown(keyCode) {
      return pressedKeys[keyCode] == true;
    }

    function isButtonDown(buttonIndex) {
      const gamepads = navigator.getGamepads ? navigator.getGamepads() : [];
      if (gamepads.length > 0) {
        const gamepad = gamepads[0];
        if (gamepad) {
          if (buttonIndex < gamepad.buttons.length) {
            return gamepad.buttons[buttonIndex].pressed;
          }
        }
      }
      return false;
    }

    function jsConsoleLog(ptr, len) {
      let str = readCharStr(ptr, len);
      console.log(str);
    }

    function onKeyDown(e) {
      // e.repeat
      pressedKeys[e.keyCode] = true;
    }

    function onKeyUp(e) {
      pressedKeys[e.keyCode] = false;
    }

    const readCharStr = (ptr, len) => {
      const array = new Uint8Array(memory.buffer, ptr, len)
      const decoder = new TextDecoder()
      return decoder.decode(array)
    }

    fetchAndInstantiate('zig-out/lib/main.wasm', { env }).then(instance => {
      memory = instance.exports.memory;
      instance.exports.onInit();

      function resize() {
        $canvasgl.width = window.devicePixelRatio * window.innerWidth;
        $canvasgl.height = window.devicePixelRatio * window.innerHeight;
        $canvasgl.style.width = window.innerWidth + "px";
        $canvasgl.style.height = window.innerHeight + "px";
        instance.exports.onResize(window.innerWidth, window.innerHeight, window.devicePixelRatio);
      }
      window.addEventListener('resize', resize, false);
      resize();

      const onAnimationFrame = instance.exports.onAnimationFrame;

      document.addEventListener('keydown', onKeyDown);
      document.addEventListener('keyup', onKeyUp);
      // document.addEventListener('mousedown', e => instance.exports.onMouseDown(e.button, e.x, e.y));
      // document.addEventListener('mouseup', e => instance.exports.onMouseUp(e.button, e.x, e.y));
      // document.addEventListener('mousemove', e => instance.exports.onMouseMove(e.x, e.y));

      function step(timestamp) {
        onAnimationFrame(timestamp);
        window.requestAnimationFrame(step);
      }

      window.requestAnimationFrame(step);
    });

    function fetchAndInstantiate(url, importObject) {
      return fetch(url)
        .then(response => response.arrayBuffer())
        .then(bytes => WebAssembly.instantiate(bytes, importObject))
        .then(results => results.instance);
    }

    function enableTouchControls() {
      const touchControls = document.querySelectorAll('.touchcontrol');
      for (const touchControl of touchControls) {
        console.log(touchControl)
        touchControl.classList.add('touchcontrol-enabled');
      }
    }
    function touchStart(e) {
      enableTouchControls();
      document.removeEventListener("touchstart", touchStart)
    }
    document.addEventListener("touchstart", touchStart);

    document.addEventListener("contextmenu", function (e) {
        e.preventDefault();
    }, false);
  </script>
</body>

</html>